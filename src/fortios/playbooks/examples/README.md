# FortiGate Example Playbooks

## Quick Start with API Key Authentication

### 1. Install the Collection

```bash
# Install from the repository
cd /path/to/es.fx.ansible
ansible-galaxy collection install ./src/fortios --force

# Or install from GitHub
ansible-galaxy collection install git+https://github.com/emberstack/es.fx.ansible.git#/src/fortios
```

### 2. Generate API Key on FortiGate

```bash
# SSH to FortiGate and run:
config system api-user
    edit "ansible"
        set api-key <auto-generated-key-will-appear-here>
        set accprofile "super_admin"  # Or your preferred profile
        config trusthost
            edit 1
                set ipv4-trusthost 0.0.0.0 0.0.0.0  # Adjust for security
            next
        end
    next
end
```

### 3. Configure Inventory

Edit `inventory.yml` and update:
- `ansible_host`: Your FortiGate IP address
- `access_token`: Your API key from step 1
- `vdom`: Your VDOM (usually "root")
- `ansible_httpapi_port`: HTTPS admin port (usually 443 or 5443)

```yaml
fortigate-01:
  ansible_host: 192.168.1.99
  access_token: "xxxxxxxxxxxxxxxxxxxxxxxxxxx"
  vdom: root
  ansible_httpapi_port: 5443
  ansible_network_os: fortinet.fortios.fortios
  ansible_connection: httpapi
  ansible_httpapi_use_ssl: true
  ansible_httpapi_validate_certs: false
```

All connection settings are now in the inventory file for simplicity. No separate group_vars configuration is required.

### 4. Test Connection

```bash
# Test the connection without making changes
ansible-playbook -i inventory.yml fortigate_connect_only.yml

# With verbose output
ansible-playbook -i inventory.yml fortigate_connect_only.yml -v
```


## Troubleshooting

### Connection Issues

1. **Verify API key is correct**:
   ```bash
   # On FortiGate CLI
   show system api-user
   ```

2. **Check connectivity**:
   ```bash
   # Test HTTPS access
   curl -k https://192.168.1.99/api/v2/cmdb/system/status?access_token=YOUR_TOKEN
   ```

3. **Enable debug mode**:
   ```bash
   ansible-playbook -i inventory.yml fortigate_connect_only.yml -vvv
   ```

### Common Errors

- **401 Unauthorized**: Invalid API key or user permissions
- **Connection refused**: Check firewall rules, HTTPS admin access
- **SSL certificate errors**: Set `ansible_httpapi_validate_certs: no`

## API Key vs Username/Password

This collection supports both authentication methods:

**API Key (Recommended)**:
- More secure (no password in files)
- Can be restricted to specific IPs
- Easy to rotate/revoke
- Set via `access_token` variable

**Username/Password**:
- Set via `ansible_user` and `ansible_password`
- Remove `access_token` from inventory
- Consider using environment variables for passwords

## Required Python Packages

```bash
pip install ansible
pip install fortiosapi  # Optional, for additional features
```

## Directory Structure

```
examples/
├── inventory.yml                 # Inventory with FortiGate details and connection settings
├── fortigate_connect_only.yml   # Connection test playbook
└── README.md                    # This file
```

Note: All connection settings are now consolidated in the inventory.yml file for simplicity.